<?xml version="1.0" encoding="UTF-8"?>
<!--
SpagoBI - The Business Intelligence Free Platform

Copyright (C) 2005 Engineering Ingegneria Informatica S.p.A.

This library is free software; you can redistribute it and/or
modify it under the terms of the GNU Lesser General Public
License as published by the Free Software Foundation; either
version 2.1 of the License, or (at your option) any later version.

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public
License along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA



DESCRIPTION:
"spagonigeo.svg" is part of the SpagoBIGeoEngine. 
It is used to perform dynamic geo-analysis.


CREDITS:
* none so far



CURRENT VERSION: 
1.0.0

VERSION HISTORY:
* 1.0.0 (2007-09-17)
initial version

* 1.0.1 (2007-09-24)
changed the name of ub variable to ub_values in order to avoid naming conflict with slider.js
changed the name of lb variable to lb_values in order to avoid naming conflict with slider.js
bug fixed in layer's checkboxes generation

--><svg contentScriptType="text/ecmascript" zoomAndPan="disable" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:svg="http://www.w3.org/2000/svg" onload="init(evt);" xmlns:attrib="http://www.carto.net/attrib" contentStyleType="text/css" version="1.0" width="100%" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:batik="http://xml.apache.org/batik/ext" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:cc="http://web.resource.org/cc/" sodipodi:version="0.32" preserveAspectRatio="xMidYMin meet" viewBox="0 0 1100 768" height="100%" xmlns="http://www.w3.org/2000/svg">

		<g id="imported_scripts">
		
	

</g>
		
		<script type="text/ecmascript" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:type="simple" xlink:actuate="onLoad" id="included_scripts" xlink:show="other"><![CDATA[
				
		]]></script>
		
		<script type="text/ecmascript" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:type="simple" xlink:actuate="onLoad" id="init" xlink:show="other"><![CDATA[


]]></script>
		
		
<script xlink:type="simple" xlink:actuate="onLoad" xlink:show="other" type="text/ecmascript" xmlns:xlink="http://www.w3.org/1999/xlink"><![CDATA[
		
		
	   
	   
	   
				
		//global variables for mapApp and map object
		var myMapApp = new mapApp();
		var myMainMap;
		var checkBoxes = new Array();
		
		var attribNS="http://www.carto.net/attrib";
		var xlinkNS = "http://www.w3.org/1999/xlink";
		var suspendProcess;
		var windowPositions = new Array();
	
		var isShowTableModalityActive = true;
			
		function init() {
			window.setTimeout("initApplication()", 500);
		}
			
		
		function initWindows() {
		
			//create windows
			myMapApp.Windows = new Array();
			
			myMapApp.Windows["navWindow"] = new NavigationWindow(true);
			myMapApp.Windows["basiclayer"] = new LayersWindow(true);
			myMapApp.Windows["thematic"] = new ThematicWindow(true);
			myMapApp.Windows["detail"] = new DetailsWindow(true);
			myMapApp.Windows["legend"] = new LegendWindow(true);
			myMapApp.Windows["colourpicker"] = new ColourPickerWindow(false);
			
			//first a few styles
			var winPlaceholderStyles = {"fill":"none","stroke":"dimgray","stroke-width":1.5};
			var windowStyles = {"fill":"#fffce6","stroke":"dimgray","stroke-width":1};
			var titlebarStyles = {"fill":"steelblue","stroke":"dimgray","stroke-width":1};
			var statusbarStyles = {"fill":"aliceblue","stroke":"dimgray","stroke-width":1};
			var titletextStyles = {"font-family":"Arial,Helvetica","font-size":14,"fill":"white"};
			var statustextStyles = {"font-family":"Arial,Helvetica","font-size":10,"fill":"dimgray"};
			var buttonStyles = {"fill":"steelblue","stroke":"white","stroke-width":2};
			var titlebarHeight = 17;
			var statusbarHeight = 13;
			
			//create checkboxes array
			myMapApp.checkBoxes = new Array();
			
			// window instances creation
			/*
			myMapApp.Windows["navWindow"] = new Window("navWindow","Windows",210,200,10,491,true,8,8,1092,690,true,winPlaceholderStyles,windowStyles,3,true,false,"Navigation","",false,true,true,titlebarStyles,titlebarHeight,statusbarStyles,statusbarHeight,titletextStyles,statustextStyles,buttonStyles,windowHandling);
			myMapApp.Windows["navWindow"].appendContent("referenceMap",true);
			myMapApp.Windows["navWindow"].appendContent("zoomIn",true);
			myMapApp.Windows["navWindow"].appendContent("zoomOut",true);
			myMapApp.Windows["navWindow"].appendContent("zoomFull",true);
			myMapApp.Windows["navWindow"].appendContent("zoomManual",true);
			myMapApp.Windows["navWindow"].appendContent("panManual",true);
			myMapApp.Windows["navWindow"].appendContent("infoButton",true);
			myMapApp.Windows["navWindow"].appendContent("backwardExtent",true);
			myMapApp.Windows["navWindow"].appendContent("forwardExtent",true);
			myMapApp.Windows["navWindow"].appendContent("mapZoomSlider",true);
			myMapApp.Windows["navWindow"].minimize(true);		
      */	
		}
		
		function closeAllWindows() {			
			myMapApp.Windows["navWindow"].close(true);					
			myMapApp.Windows["basiclayer"].close(true);		
			myMapApp.Windows["thematic"].close(true);			
			myMapApp.Windows["detail"].close(true);		
			myMapApp.Windows["legend"].close(true);
		}

	
		/*
		function initButtons() {
			// create buttons
			myMapApp.buttons = new Array();
			
			//first a few styles
			var buttonTextStyles = {"font-family":"Arial,Helvetica","fill":"dimgray","font-size":10};
			var buttonStyles = {"fill":"white"};
			var shadeLightStyles = {"fill":"rgb(235,235,235)"};
			var shadeDarkStyles = {"fill":"dimgray"};
			
			//button instances creation
			
			myMapApp.buttons["zoomIn"] = new button("zoomIn",zoomImageButtons,"rect",undefined,"magnifyerZoomIn",7,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["zoomOut"] = new button("zoomOut",zoomImageButtons,"rect",undefined,"magnifyerZoomOut",32,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["infoButton"] = new switchbutton("infoButton",zoomImageSwitchButtons,"rect",undefined,"infoBut",132,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["infoButton"].setSwitchValue(true,false);
			statusChange("Mode: Infomode");
			myMapApp.buttons["zoomFull"] = new button("zoomFull",zoomImageButtons,"rect",undefined,"magnifyerFull",57,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["zoomManual"] = new switchbutton("zoomManual",zoomImageSwitchButtons,"rect",undefined,"magnifyerManual",82,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["panManual"] = new switchbutton("panManual",zoomImageSwitchButtons,"rect",undefined,"symbPan",107,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["recenterMap"] = new switchbutton("recenterMap",zoomImageSwitchButtons,"rect",undefined,"symbRecenter",132,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["backwardExtent"] = new button("backwardExtent",zoomImageButtons,"rect",undefined,"symbArrowLeft",157,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			myMapApp.buttons["forwardExtent"] = new button("forwardExtent",zoomImageButtons,"rect",undefined,"symbArrowRight",182,165,20,20,buttonTextStyles,buttonStyles,shadeLightStyles,shadeDarkStyles,1);
			
			//see if we need to disable buttons
			myMainMap.checkButtons();
		}
		*/
		
		
		
	
		/*
		function initSliders() {
			
			var sliderStyles = {"stroke":"dimgray","stroke-width":"2","fill":"dimgray"};
					
			
			myMapApp.zoomSlider = new slider("zoomSliderId", 
											 "mapZoomSlider", 
											 180,153,
											 myMainMap.minWidth,
											 20,153,
											 myMainMap.maxWidth,
											 myMainMap.maxWidth,
											 sliderStyles, 
											 15,
											 "sliderSymbol",
											 myMapApp.refMapDragger,			
										     true);
		}
		
		*/
			
		function initApplication(evt) {	
      		
			if (document.documentElement.suspendRedraw) {
				suspendProcess = document.documentElement.suspendRedraw(30000);
			}
		  
		
		  
			
			setTresholds();
			setColourRange();
			
			initMainMap();			
			initWindows();
			if(activeWindow == false) {
				closeAllWindows();
			}
			//initButtons();
			//initSliders();		      			
			
      
			myMapApp.Windows["basiclayer"].createCheckBoxes();
			myMapApp.Windows["thematic"].addThemes();
			myMapApp.Windows["detail"].initTabGroups();
			myMapApp.Windows["detail"].initDetailInfopanels();   
			myMapApp.Windows["legend"].initLegendEntries();
      
		
			
			myMapApp.loadStatus = document.getElementById("statusColorMap");
			myMapApp.loadStatus = document.getElementById("statusColorMap");
			myMapApp.targetLayer = document.getElementById(layer_names[target_layer_index]);
			
			loadProjectSpecific();
			
			if (document.documentElement.suspendRedraw) {
				document.documentElement.unsuspendRedraw(suspendProcess);
			}
		}
		
		
		
		
		
		
	   //this function is called after each pan or zoom or change of map extent
       //you can place project specific functions here that need to re.on the map extent, e.g. adopting line-widths, loading additional data, etc.
       function loadProjectSpecific() {
           var names = [];
           var values = [];
           var maxValue = 0;
           var child = myMapApp.targetLayer.firstChild;
           while(child) {
           	   var targetNode = child;	
               if(targetNode.nodeName == "a") {
               		targetNode = targetNode.firstChild;
               }
               
               if (targetNode.nodeName == "path") {
                   for(i = 0; i < kpi_names.length; i++) {
                       var t = parseFloat(targetNode.getAttributeNS(attribNS, kpi_names[i]));
                       if(t > maxValue) {
                           maxValue = t;
                       }
                   }
               }
               child = child.nextSibling;
           }     
          					
                                               
           var detailBarChartRenderer = new BarChartRenderer(50, 35,100,100,3);
           detailBarChartRenderer.maxGridLineValue = maxValue;
           var layerBarChartRenderer = new BarChartRenderer(50, 35,100,100,3);
           layerBarChartRenderer.maxGridLineValue = maxValue;
           layerBarChartRenderer.gridLineVisible = false;
           layerBarChartRenderer.labelsVisible = false;
           child = myMapApp.targetLayer.firstChild;
           while(child) {
           
               var targetNode = child;	
               if(targetNode.nodeName == "a") {
	               	var crossUrl = targetNode.getAttributeNS(xlinkNS, "href");
					var drillUrl = "../servlet/AdapterHTTP?ACTION_NAME=SHOW_DATA_DETAILS_ACTION";
					var featureValue = targetNode.firstChild.getAttribute("id");
					drillUrl += "&featureValue=" + featureValue;
					targetNode.setAttributeNS(attribNS, "crossUrl", crossUrl);
					targetNode.setAttributeNS(attribNS, "drillUrl", drillUrl);
					if (defaultDrillNav == true){
						targetNode.setAttributeNS(xlinkNS, "href", drillUrl);
					} else {
						targetNode.setAttributeNS(xlinkNS, "href", crossUrl);
					}
	               	targetNode = targetNode.firstChild;
               }
			   
               if (targetNode.nodeName == "path") {
                   names = new Array();
                   values = new Array();
                                     for(i = 0; i < kpi_names.length; i++) {
                       names[i] = kpi_names[i];
                       values[i] = targetNode.getAttributeNS(attribNS, kpi_names[i]);
                   }
                                     detailBarChartRenderer.setDataset(names, values, kpi_colours);
                   detailBarChartRenderer.render(document.getElementById("detailTabGroup__1_content"), targetNode.getAttributeNS(null, "id") + "_chart", "none");
                   if(includeChartLayer == true) {
                       layerBarChartRenderer.setDataset(names, values, kpi_colours);
                       var chartW = 800;
                       var chartH = 1600;
                       var centroide = document.getElementById("centroidi_" + targetNode.getAttributeNS(null, "id"));
                       if(centroide != null) {
                       	   layerBarChartRenderer.chartX = centroide.getAttributeNS(null, "cx") - (chartW/2);
	                       layerBarChartRenderer.chartY = centroide.getAttributeNS(null, "cy") - (chartH);
	                       layerBarChartRenderer.chartW = chartW;
	                       layerBarChartRenderer.chartH = chartH;
	                       layerBarChartRenderer.render(document.getElementById("grafici"), targetNode.getAttributeNS(null, "id") + "_chartLayer", "inherit");
                   	   } else {
                   	   	//alert("Nessun centroide per " + targetNode.getAttributeNS(null, "id") + "!!!");
                   	   }
                   }
                   
                   if(includeValuesLayer == true) {
                       var text;
                       
                       var rounded_value = values[selected_kpi_index];
                   	   var value_string = rounded_value.toString();
		   			   var decimal_location = value_string.indexOf(".");		
		   			   if (decimal_location != -1) {
                   	   		var value_float = round_decimals( parseFloat(value_string), 2 );
                   	   		text = value_float.toString();
                   	   } else {                       	
                       		text = values[selected_kpi_index];
                  	   }
                       
                       
                       var valueLabel = document.createElementNS(svgNS,"text");
                       var centroide = document.getElementById("centroidi_" + targetNode.getAttributeNS(null, "id"));
                       if(centroide != null) {
	                       valueLabel.setAttribute("x",centroide.getAttributeNS(null, "cx"));
	                       valueLabel.setAttribute("y",centroide.getAttributeNS(null, "cy"));
	                       valueLabel.setAttribute("id", "label_" + targetNode.getAttributeNS(null, "id"));
	                       valueLabel.setAttribute("text-anchor","middle");
	                       valueLabel.setAttribute("font-family","Arial,Helvetica");
	                       valueLabel.setAttribute("font-size","600px");
	                       valueLabel.setAttribute("fill","black");
	                       var textNode = document.createTextNode(text);
	                       valueLabel.appendChild(textNode);
	                       var valuesLayer = document.getElementById("valori");
	                       valuesLayer.appendChild(valueLabel);
	                    } else {
	                    	//alert("Nessun centroide per " + targetNode.getAttributeNS(null, "id") + "!!!");
	                    }
                   }
               }
               child = child.nextSibling;
           }
       } 
		
	  
		function initMainMap() {
			//dynamic layer array that allow loading from database
			var dynamicLayers = new Array();
			
			//initialize digiLayers (layers that allow digitizing)
			var digiLayers = new Array();
			
			//define some styles for the map object
			var zoomRectStyles = {"fill":"none","stroke":"crimson","stroke-width":0.002,"stroke-dasharray":"0.012,0.002"};
			var highlightStyles = {"stroke":"crimson","stroke-width":0.002};
			var dragRectStyles = {"fill":"dimgray","fill-opacity":0.3};
						
			//initialize myMainMap object, you need to adopt the parameters here
			myMainMap = new map("mainMap",35910,35,0.6,0,26911,"m",1,false,"","",dynamicLayers,digiLayers,"",zoomRectStyles,highlightStyles,dragRectStyles,"referenceMap","myDragCrossSymbol",4750);
		}
		
		
		
		function setColourRange() {
			for(i = 0; i < kpi_names.length; i++) {	
				if(colorRangeCalculationType[kpi_names[i]] == "gradient") {
					setGradientColourRange(kpi_names[i]);
				} else if (colorRangeCalculationType[kpi_names[i]] == "static") {
					// do nothing
				} else {
					setGradientColourRange(kpi_names[i]);
				}
			}
		}
		
		function setGradientColourRange(kpiName) { 
			var A = new Array();
			var Grad = new Array();
			var new_rA;
			var new_gA;
			var new_bA;
			var shade;
			
			// splitting color components, conversion to decimal, and storing in array
			A["r"] = parseInt(colorRangeCalculationGradParams[kpiName].substring(1,3),16);
			A["g"] = parseInt(colorRangeCalculationGradParams[kpiName].substring(3,5),16);
			A["b"] = parseInt(colorRangeCalculationGradParams[kpiName].substring(5),16);
			RGB = [A["r"],A["g"],A["b"]].sort(function(a,b) {return parseInt(a) - parseInt(b)}); 
			for(comp in A) {
				if(A[comp] == RGB[2]) Grad[comp] = parseInt((240 - A[comp]) / (num_group[kpiName] - 1));	
				else if(A[comp] == RGB[1]) Grad[comp] = parseInt((230 - A[comp]) / (num_group[kpiName] - 1));
				else  Grad[comp] = parseInt((220 - A[comp]) / (num_group[kpiName] - 1));
			}
			
			eval("col_"+kpiName+"=new Array()");
		    var colorRangeArray = eval("col_"+kpiName);
		    colorRangeArray[0] = colorRangeCalculationGradParams[kpiName];
		   
		    
			for(var j = 1; j < num_group[kpiName]; j++) {
				new_rA = A["r"] + Grad["r"] * j;
				new_gA = A["g"] + Grad["g"] * j;
				new_bA = A["b"] + Grad["b"] * j;
				//alert(new_rA + " " + new_gA + " " + new_bA);
				shade = "#" + new_rA.toString(16) + new_gA.toString(16) + new_bA.toString(16);	
				colorRangeArray[j] = shade;		
			}
			colorRangeArray.reverse();
			
			//alert(kpiName + " - " + colorRangeArray);	
		}
		
		
		
		
		
	   function setTresholds() {	   		
	   
	   		//alert('setTresholds');
			for(i = 0; i < kpi_names.length; i++) {					
				
				if(lb_values[kpi_names[i]] == null) {
		   			lb_values[kpi_names[i]] = kpi_ordered_values[kpi_names[i]][0];
		   		}
		   		if(ub_values[kpi_names[i]] == null) {
		   			ub_values[kpi_names[i]] = kpi_ordered_values[kpi_names[i]][kpi_ordered_values[kpi_names[i]].length-1];
		   		}
		   		
		   		if(lb_values[kpi_names[i]] > ub_values[kpi_names[i]]) {
		   			var t = lb_values[kpi_names[i]];
		   			ub_values[kpi_names[i]] = lb_values[kpi_names[i]];
		   			lb_values[kpi_names[i]] = t;
		   		}
		   		
		   		if(ub_values[kpi_names[i]] < kpi_ordered_values[kpi_names[i]][0] || lb_values[kpi_names[i]] >  kpi_ordered_values[kpi_names[i]][kpi_ordered_values[kpi_names[i]].length-1]) {
		   			lb_values[kpi_names[i]] = kpi_ordered_values[kpi_names[i]][0];
		   			ub_values[kpi_names[i]] = kpi_ordered_values[kpi_names[i]][kpi_ordered_values[kpi_names[i]].length-1];
		   		}
				
				
				
				if(trasholdCalculationType[kpi_names[i]] == "quantile") {
					setQuantileTrasholds(kpi_names[i]);
				} else if (trasholdCalculationType[kpi_names[i]] == "perc") {
					setPercTrasholds(kpi_names[i]);
				} else if (trasholdCalculationType[kpi_names[i]] == "uniform") {
					setUniformTrasholds(kpi_names[i]);
				} else if (trasholdCalculationType[kpi_names[i]] == "static") {
					num_group[kpi_names[i]] = eval("thresh_"+kpi_names[i]+".length-1");
				} else {
					setQuantileTrasholds(kpi_names[i]);
				}
				
				
				
			}
		}
		
		function setPercTrasholds(kpiName) { 
			var range = ub_values[kpiName] - lb_values[kpiName];
			
			eval("thresh_"+kpiName+"=new Array()");
		    var trasholds = eval("thresh_"+kpiName);
		    trasholds[0] = lb_values[kpiName];
		   
			for(var j = 0; j < trasholdCalculationPercParams[kpiName].length-1; j++) {
				var groupSize = (range / 100.0) * trasholdCalculationPercParams[kpiName][j];
				trasholds[j+1] = trasholds[j] + groupSize;
			}
			
			trasholds[trasholdCalculationPercParams[kpiName].length] = ub_values[kpiName];	
			
			num_group[kpiName] = trasholdCalculationPercParams[kpiName].length;
		}
		
		function setUniformTrasholds(kpiName) { 
			trasholdCalculationPercParams[kpiName] = new Array();
			var perc = 100 / trasholdCalculationUniformParams[kpiName];
			for(var j = 0; j < trasholdCalculationUniformParams[kpiName]; j++) {
				trasholdCalculationPercParams[kpiName][j] = perc;
			}
			setPercTrasholds(kpiName);
		}
		
		function setQuantileTrasholds(kpiName) {
				
				/*
				if(lb_values[kpiName] == null) {
		   			lb_values[kpiName] = kpi_ordered_values[kpiName][0];
		   		}
		   		if(ub_values[kpiName] == null) {
		   			ub_values[kpiName] = kpi_ordered_values[kpiName][kpi_ordered_values[kpi_name].length-1];
		   		}
		   		
		   		if(lb_values[kpiName] > ub_values[kpiName]) {
		   			var t = lb_values[kpiName];
		   			ub_values[kpiName] = lb_values[kpiName];
		   			lb_values[kpiName] = t;
		   		}
		   		
		   		if(ub_values[kpiName] < kpi_ordered_values[kpiName][0] || lb_values[kpiName] >  kpi_ordered_values[kpiName][kpi_ordered_values[kpiName].length-1]) {
		   			lb_values[kpiName] = kpi_ordered_values[kpiName][0];
		   			ub_values[kpiName] = kpi_ordered_values[kpiName][kpi_ordered_values[kpiName].length-1];
		   		}
		   		*/
				
				eval("thresh_"+kpiName+"=new Array()");
				var trasholds = eval("thresh_"+kpiName);
				
				var diff_value_num = 0;	
				var start_index = -1;	
				if(kpi_ordered_values[kpiName][0] >= lb_values[kpiName] && kpi_ordered_values[kpiName][kpi_ordered_values[kpiName].length-1] <= ub_values[kpiName]) {
					diff_value_num = kpi_ordered_values[kpiName].length;
					start_index = 0;
				} else {
					for(j = 0; j < kpi_ordered_values[kpiName].length; j++) {						
			   			if(kpi_ordered_values[kpiName][j] >= lb_values[kpiName] && kpi_ordered_values[kpiName][j] <= ub_values[kpiName]) {
			   				start_index = (start_index == -1?j:start_index);
			   				diff_value_num++;
			   			}
		   			}
		   		}
		   		
		   		
				if(diff_value_num < num_group[kpiName]) num_group[kpiName] = diff_value_num;
				var blockSize = Math.floor( diff_value_num / num_group[kpiName] );
			
				trasholds[0] = lb_values[kpiName];
				for(j = 1; j < num_group[kpiName] ; j++){
					trasholds[j] = kpi_ordered_values[kpiName][start_index + (j*blockSize)];
				}
				trasholds[num_group[kpiName]] = ub_values[kpiName];
		}
		
			
		//this function toggles the display attribute of a map layer
		function toggleMapLayer(id,checkStatus,labelText) {
			var layerId = id.replace(/cb_/, "");
			var mapLayer = document.getElementById(layerId);
			var displayStatus = "none";
			if (checkStatus) {
				displayStatus = "inherit";
			}
			mapLayer.setAttributeNS(null,"display",displayStatus);
		}
		
		
		
		function setKpi(cbId,radioId,label) {
			if (document.documentElement.suspendRedraw) {
				suspendProcess = document.documentElement.suspendRedraw(30000);
			}
			//set current topic in mapApp object
			myMapApp.curKpi = radioId;
			myMapApp.colArray = eval("col_"+myMapApp.curKpi);
			myMapApp.threshArray = eval("thresh_"+myMapApp.curKpi);
			myMapApp.curLabel = label;
			
			var coulourBoxes = document.getElementById("coulourboxes");			
			for(i = 0; i < myMapApp.legRect.length; i++) {
				coulourBoxes.removeChild(myMapApp.legRect[i]);
				coulourBoxes.removeChild(myMapApp.legPanel[i]);
			}
			
			
			
			myMapApp.legPanel = new Array();	
			myMapApp.legRect = new Array();		
			for(i = 0; i < num_group[myMapApp.curKpi]; i++) {
				// ...legendpanel
				var offset = 50 + (i*25);
				var panel = document.createElementNS(svgNS,"text");
				panel.setAttribute("id","legpanel" + (i+1));
				panel.setAttribute("x", "70");
				panel.setAttribute("y", "" + offset);
				panel.setAttribute("fill", "dimgray");
				panel.setAttribute("font-family", "Arial,Helvetica");
				panel.setAttribute("font-size", "14px");
				panel.setAttribute("startOffset", "0");
				var closingChar = (i!=num_group[myMapApp.curKpi]-1?")":"]");
				var textString = "-   [" + number_to_string(myMapApp.threshArray[i],2) + " - " + number_to_string(myMapApp.threshArray[i+1],2) + closingChar;
				var text_node = document.createTextNode(textString);
				panel.appendChild(text_node);
				
				coulourBoxes.appendChild(panel);
				
				myMapApp.legPanel[i] = panel;
				
				// ...legendrect
				var offset = 35 + (i*25);
				var rect = document.createElementNS(svgNS,"rect");
				rect.setAttribute("id","rect" + (i+1));
				rect.setAttribute("stroke","dimgray");
				rect.setAttribute("x","30");
				rect.setAttribute("y",offset);
				rect.setAttribute("width","30");
				rect.setAttribute("height","20");
				rect.setAttribute("fill",myMapApp.colArray[i]);
				rect.setAttribute("onclick", "myMapApp.Windows['colourpicker'].openColourPiker(evt)");
				rect.setAttribute("cursor", "pointer");
				
				coulourBoxes.appendChild(rect);
				
				myMapApp.legRect[i] = rect;
			}	
			
			
			myMapApp.loadStatus.setAttributeNS(null,"display","inline");		
			
			window.setTimeout("colourMap()",200);
			if (document.documentElement.suspendRedraw) {
				document.documentElement.unsuspendRedraw(suspendProcess);
			}
		}
			
			
		function mouseClickHandler(evt) {
			var targetElemet = evt.target;
		}	
		
		function setLinkAction(cbId,radioId,label) {
			var child = myMapApp.targetLayer.firstChild;
		 	
			while(child) {
			
				var targetNode = child;					
				if (targetNode.nodeName == "a") {
					var url;
					if(radioId == "drill_nav") {
						url = targetNode.getAttributeNS(attribNS, "drillUrl");
					} else {
						url = targetNode.getAttributeNS(attribNS, "crossUrl");
					}						
					targetNode.setAttributeNS(xlinkNS, "href", url);
				}
				child = child.nextSibling;
			}
		}
		
		function round_decimals(original_number, decimals) {
		   var result1 = original_number * Math.pow(10, decimals);
		   var result2 = Math.round(result1);
		   var result3 = result2 / Math.pow(10, decimals);
		   return pad_with_zeros(result3, decimals);
		}
			
		function pad_with_zeros(rounded_value, decimal_places) {
		
		   // Convert the number to a string
		   var value_string = rounded_value.toString();
		   
		   // Locate the decimal point
		   var decimal_location = value_string.indexOf(".");
		
		   // Is there a decimal point?
		   if (decimal_location == -1) {
		       // If no, then all decimal places will be padded with 0s
		       decimal_part_length = 0;
		       // If decimal_places is greater than zero, tack on a decimal point
		       value_string += decimal_places > 0 ? "." : "";
		   } else {		
		       // If yes, then only the extra decimal places will be padded with 0s
		       decimal_part_length = value_string.length - decimal_location - 1;
		   }
		   
		   // Calculate the number of decimal places that need to be padded with 0s
		   var pad_total = decimal_places - decimal_part_length;
		   if (pad_total > 0) {
		   		// Pad the string with 0s
		   		for (var counter = 1; counter <= pad_total; counter++) value_string += "0";
		   }
		   return value_string;
		}
		
		function number_to_string(rounded_value, decimals) {
			var result = null;
			var value_string = rounded_value.toString();
		   	var decimal_location = value_string.indexOf(".");		
		    if (decimal_location != -1) {
                var value_float = parseFloat(value_string);
            	result = round_decimals(value_float, decimals);
             } else {                       	
                result = value_string;
             }
             
             return result;
		}

        function showData(evt){
           var el = evt.target;
           var nome = el.getAttributeNS(attribNS,"nome");
           if(nome == null || nome == "") nome = el.getAttribute("id");
           
           var id = el.getAttributeNS(null,"id");
           var kpi_values = [];
           
           for(i = 0; i < kpi_names.length; i++) {
                   kpi_values[kpi_names[i]] = el.getAttributeNS(attribNS,kpi_names[i]);
           }
           
           var targetValue = parseFloat(kpi_values[myMapApp.curKpi]);
           
           //determine class
           var colIndex = -1;   
           
           if(targetValue ==  myMapApp.threshArray[myMapApp.threshArray.length-1] ) {
           		colIndex = myMapApp.threshArray.length-2;
           } else {             
	           for (var i = 0;i<myMapApp.threshArray.length-1;i++) {
	               if (targetValue >= myMapApp.threshArray[i] && targetValue <  myMapApp.threshArray[i+1]) {
	                   colIndex = i;
	                   break;
	               }
	           }
	       }
           
           var curLegendRect = (colIndex != -1? eval("myMapApp.legRect[" + colIndex + "]") : null);
           
           if (evt.type=="mouseover"){
               myMapApp.Windows["detail"].setTitleText(nome);
               if (!myMapApp.Windows["detail"].closed) {
                   for(i = 0; i < kpi_names.length; i++) {
                        var rounded_value = kpi_values[kpi_names[i]];
                   		var value_string = rounded_value.toString();
		   				var decimal_location = value_string.indexOf(".");		
		   				if (decimal_location != -1) {
                   	   		var value_float = parseFloat(kpi_values[kpi_names[i]]);
                   	   		myMapApp.infoPanel[i].firstChild.nodeValue = kpi_descriptions[i] + " " + round_decimals(value_float,2);
                   	   	} else {                       	
                       		myMapApp.infoPanel[i].firstChild.nodeValue = kpi_descriptions[i] + " " + kpi_values[kpi_names[i]];
                  		}
				   }
                   if(document.getElementById(id + "_chart") != null) {
                   		document.getElementById(id + "_chart").setAttributeNS(null, "display","block");
                   }
                }
                             
                myMapApp.Windows["legend"].setTitleText(myMapApp.curKpi + ": " + round_decimals(targetValue,2));
               	if (curLegendRect != null && !myMapApp.Windows["legend"].closed) {
                   curLegendRect.setAttributeNS(null, "stroke-width",2);
                   curLegendRect.setAttributeNS(null, "stroke","black");
               	}
            }
                     
            if (evt.type=="mouseout"){
               myMapApp.Windows["detail"].setTitleText("Detail");
               if (!myMapApp.Windows["detail"].closed) {
                   for(i = 0; i < kpi_names.length; i++) {
                       myMapApp.infoPanel[i].firstChild.nodeValue = kpi_descriptions[i] + " ";
                   }
                   if(document.getElementById(id + "_chart") != null) {
                       document.getElementById(id + "_chart").setAttributeNS(null, "display","none");
                   }
               }
               myMapApp.Windows["legend"].setTitleText("Legend");
               if (curLegendRect != null && !myMapApp.Windows["legend"].closed) {
                   curLegendRect.setAttributeNS(null, "stroke-width",1);
                   curLegendRect.setAttributeNS(null, "stroke","dimgray");
               }
             }
        } 
			
	
		function colourMap() {
			if (document.documentElement.suspendRedraw) {
				suspendProcess = document.documentElement.suspendRedraw(20000);
			}
						
			var child = myMapApp.targetLayer.firstChild;
			 
			while(child) {
				
				var targetNode = child;
				if (child.nodeName == "a") {
					targetNode = child.firstChild;
				}
				
				if (targetNode.nodeName == "path") {
					var kpiAttrib = parseInt(targetNode.getAttributeNS(attribNS,myMapApp.curKpi));
			
			
					var targetColor = "#666666";
					
					
					if(targetNode.getAttributeNS(attribNS,myMapApp.curKpi) == "") {
						targetColor = null_values_color[myMapApp.curKpi];
					} else if(kpiAttrib < lb_values[myMapApp.curKpi]) {
						targetColor = lb_color[myMapApp.curKpi];
					} else if(kpiAttrib > ub_values[myMapApp.curKpi]) {
						targetColor = ub_color[myMapApp.curKpi];
					} else if(kpiAttrib == ub_values[myMapApp.curKpi]) {
						targetColor = myMapApp.colArray[myMapApp.threshArray.length-2];
					} else  {
						for (var i = 0;i<myMapApp.threshArray.length-1;i++) {
							if (kpiAttrib >= myMapApp.threshArray[i] && kpiAttrib <  myMapApp.threshArray[i+1]) {
								targetColor = myMapApp.colArray[i];
								break;
							} 
						}
					}
					
          alert(targetNode +  " : " + targetNode.id + " : " + targetColor);
					
					targetNode.setAttributeNS(null,"fill",targetColor);
					
					if(includeValuesLayer == true) {
					   var text = "";
					   var rounded_value = targetNode.getAttributeNS(attribNS,myMapApp.curKpi);
                   	   var value_string = rounded_value.toString();
		   			   var decimal_location = value_string.indexOf(".");		
		   			   if (decimal_location != -1) {
		   			   		//alert(value_string + " - " + parseFloat(value_string) + " - " + round_decimals(parseFloat(value_string), 2) );
                   	   		var value_float = round_decimals( parseFloat(value_string), 2 );
                   	   		text = value_float.toString();
                   	   } else {                       	
                       		text = targetNode.getAttributeNS(attribNS,myMapApp.curKpi);
                  	   }
						var valueLabel = document.getElementById("label_" + targetNode.getAttributeNS(null, "id"));					
						if(valueLabel != null) {
							valueLabel.firstChild.nodeValue = text;
						}
					}
				}
				
				child = child.nextSibling;
			}
			
			myMapApp.loadStatus.setAttributeNS(null,"display","none");
			if (document.documentElement.suspendRedraw) {
				document.documentElement.unsuspendRedraw(suspendProcess);
			}
		}
			
	function windowHandling(id,evtType) {
		if (evtType == "minimized") {
			windowPositions[id] = {"x":myMapApp.Windows[id].transX,"y":myMapApp.Windows[id].transY};
			myMapApp.Windows[id].moveable = false;
			y = 720;
			if (id == "navWindow") {
				x = 10;
			}
			if (id == "basiclayer") {
				x = 436;
			}
			if (id == "thematic") {
				x = 223;
			}
			if (id == "legend") {
				x = 862;
			}
			if (id == "detail") {
				x = 649;
			}
			
			myMapApp.Windows[id].moveTo(x,y,false);
		}
		if (evtType == "maximized") {
			myMapApp.Windows[id].moveTo(windowPositions[id].x,windowPositions[id].y,false);
			myMapApp.Windows[id].moveable = true;
		}
	}
			
]]></script>
		
		<defs>
		
		
		
		
			<!-- Symbols for checkboxes -->
			<symbol overflow="visible" preserveAspectRatio="xMinYMin meet" id="checkBoxRect">
				<rect x="-6" y="-6" fill="white" width="12" height="12" stroke="dimgray" stroke-width="1.5"/>
			</symbol>
			
			<symbol fill="none" id="checkBoxCross" preserveAspectRatio="xMidYMid meet" stroke="dimgray" overflow="visible" stroke-width="1" pointer-events="none">
				<line y2="5" x1="-5" x2="5" y1="-5"/>
				<line y2="-5" x1="-5" x2="5" y1="5"/>
			</symbol>
			<!-- symbols for radio buttons -->
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="radioBorder">
				<circle cursor="pointer" fill="white" r="5" cx="0" cy="0" stroke="dimgray" stroke-width="1.5"/>
			</symbol>
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="radioPoint">
				<circle fill="dimgray" r="3" pointer-events="none" cx="0" cy="0"/>
			</symbol>
			<!-- Symbols for Zoom Magnifyer glasses -->
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="magnifyerFull">
				<text font-size="18px" y="7.5" startOffset="0" fill="dimgray" text-anchor="middle" font-family="Arial,Helvetica" font-weight="bold" pointer-events="none">F</text>
			</symbol>
			
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="infoBut">
				<circle fill="none" r="7.5" cx="0" cy="0" stroke="dimgray" stroke-width="1.5"/>
				<text font-size="13px" y="5" startOffset="0" fill="dimgray" text-anchor="middle" font-family="Arial,Helvetica" font-weight="bold" pointer-events="none">i</text>
			</symbol>
			<symbol fill="none" id="magnifyerManual" preserveAspectRatio="xMidYMid meet" stroke="dimgray" overflow="visible" stroke-width="1.5">
				<rect x="-6" width="12" y="-6" height="12" stroke-dasharray="1.5,1.5"/>
				<line y2="0" x1="-3" x2="3" y1="0"/>
				<line y2="3" x1="0" x2="0" y1="-3"/>
				
			</symbol>
			<symbol fill="none" id="magnifyerZoomIn" preserveAspectRatio="xMidYMid meet" stroke="dimgray" overflow="visible" stroke-width="2">
				<line y2="0" x1="-4" x2="4" y1="0"/>
				<line y2="4" x1="0" x2="0" y1="-4"/>
			</symbol>
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="magnifyerZoomOut">
				<line fill="none" x1="-4" x2="4" y1="0" y2="0" stroke="dimgray" stroke-width="2"/>
			</symbol>
			<!-- hand symbol for panning -->
			
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="symbPan">
				<path fill="none" stroke-width="1" d="M-2 6 C -2.2 2.5 -8.0 -0 -5.7 -1.9 C -4.3 -2.5 -3.3 -0.5 -2.5 0.7 C -3.2 -2.1 -5.5 -5.2 -3.6 -5.8 C -2.1 -6.3 -1.6 -3.6 -1.1 -1.9 C -0.9 -4.2 -1.6 -6.4 -0.2 -6.6 C 1.4 -6.8 0.9 -3 1.1 -1.9 C 1.5 -3.5 1.2 -6.1 2.5 -6.1 C 3.9 -6.1 3.5 -3.2 3.6 -1.6 C 4 -2.9 4.1 -4.3 5.3 -4.4 C 7.3 -3.5 4 2.2 3 6z" transform="scale(1.2)" stroke="dimgray"/>
			</symbol>
			<!-- Symbol for Arrows -->
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="symbArrow">
				<polyline fill="none" stroke-width="1" points="-3,-6 3,-6 3,1 5,1 0,7 -5,1 -3,1 -3,-5" stroke="dimgray"/>
			</symbol>
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="symbArrowLeft">
				<use transform="rotate(90)" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#symbArrow" xlink:type="simple" xlink:actuate="onLoad" xlink:show="embed"/>
				
			</symbol>
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="symbArrowRight">
				<use transform="rotate(-90)" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#symbArrow" xlink:type="simple" xlink:actuate="onLoad" xlink:show="embed"/>
			</symbol>
			<!-- Symbol for Recentering Map -->
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="symbRecenter">
				<circle fill="dimgray" r="1" pointer-events="none" cx="0" cy="0"/>
				<g fill="none" stroke-width="1.5" pointer-events="none" stroke="dimgray">
					<line y2="-3" x1="-7" x2="-3" y1="-7"/>
					
					<line y2="3" x1="7" x2="3" y1="7"/>
					<line y2="3" x1="-7" x2="-3" y1="7"/>
					<line y2="-3" x1="7" x2="3" y1="-7"/>
				</g>
			</symbol>
			<!-- Symbol for Slider -->
			<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="sliderSymbol" pointer-events="none">
				<line fill="none" x1="0" x2="0" y1="-5" y2="5" stroke="dimgray" stroke-width="5"/>
			</symbol>
			
			<!-- Symbol for Dragging if zoomed in far -->
			<symbol fill="none" id="myDragCrossSymbol" preserveAspectRatio="xMidYMid meet" stroke="darkblue" stroke-width="2000" overflow="visible" pointer-events="none">
				<line y2="0" x1="-7000" x2="-2500" y1="0"/>
				<line y2="0" x1="7000" x2="2500" y1="0"/>
				<line y2="-7800" x1="0" x2="0" y1="-3300"/>
				<line y2="7800" x1="0" x2="0" y1="3300"/>
			</symbol>
			<!-- Marker for Extent-Arrows -->
			<marker overflow="visible" preserveAspectRatio="xMidYMid meet" id="myStartArrow" orient="auto">
				
				<polyline fill="dimgray" points="-0.5,0 8,-2 8,2"/>
			</marker>
			<marker overflow="visible" preserveAspectRatio="xMidYMid meet" id="myEndArrow" orient="auto">
				<polyline fill="dimgray" points="0.5,0 -8,-2 -8,2"/>
			</marker>
		<symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="maximizeButton">
    
    
    <rect x="-5.5" y="-5.5" fill="steelblue" width="11" height="11" stroke="white" stroke-width="2" pointer-events="fill"/>
    </symbol><symbol overflow="visible" preserveAspectRatio="xMidYMid meet" id="minimizeButton">
    <rect x="-5.5" y="-5.5" fill="steelblue" width="11" height="11" pointer-events="fill"/>
    <line x1="5.5" x2="-5.5" y1="5.5" y2="5.5" stroke="white" stroke-width="2"/></symbol>
    </defs>
		
    <title>SpagoBI Geo Engine</title>
		
	
		<!-- Main Map Frame -->
		<svg contentScriptType="text/ecmascript" zoomAndPan="magnify" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:attrib="http://www.carto.net/attrib" contentStyleType="text/css" id="mainMap" version="1.0" width="1100" preserveAspectRatio="xMidYMid meet" viewBox="0 0 958.69 592.78998" height="768" xmlns="http://www.w3.org/2000/svg" x="0" y="0">
			
			<style type="text/css" xml:space="preserve">
				<![CDATA[
				circle {stroke-width:2}
				]]>
			</style>


				
				<g id="mainMapGroup">
		
			
				<g id="eventCatcher" stroke-linecap="round" onmouseover="showData(evt)" fill="white" stroke-linejoin="round" onmouseout="showData(evt)"  stroke-width="2000">
				
				<g id="targetMap">
				
				
				
				</g>
				
				



    
				
				<g stroke-linecap="square " fill="white" stroke-linejoin="miter" id="grafici" stroke="black" stroke-width="0.2">	</g>
				<g stroke-linecap="square " fill="white" stroke-linejoin="miter" id="valori" stroke="black" stroke-width="0.2">	</g>
				
				</g>
				</g>
		</svg>

	
	<g id="statusColorMap" display="none">
		<rect x="500" y="200" fill-opacity="0.8" fill="#fffce6" width="160" height="50"/>
		<text x="515" font-size="14px" y="220" startOffset="0" fill="steelblue" font-family="Arial,Helvetica">loading Data ...</text>
		<text x="560" font-size="14px" y="240" startOffset="0" fill="steelblue" font-family="Arial,Helvetica">...coloring Map</text>
	</g>
	
	
	
	    <!-- WINDOWS CONTENT -->
	    <g id="Windows">
	    
        <g id="navWindow" transform="translate(10,537)">
	       <svg contentScriptType="text/ecmascript" zoomAndPan="magnify" xmlns:xlink="http://www.w3.org/1999/xlink" display="inherit" contentStyleType="text/css" id="referenceMap" version="1.0" width="190" preserveAspectRatio="xMidYMid meet" cursor="crosshair" viewBox="-2471570.4 -1631093.7 4844781 3030131.8" height="150" xmlns="http://www.w3.org/2000/svg" x="10" y="8">
							
								<use stroke-linecap="round" fill="white" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#mainMapGroup" stroke-linejoin="round" xlink:type="simple" xlink:actuate="onLoad" xlink:show="embed" stroke-width="2419.9" pointer-events="none"/>
							
								<use x="-2471570.4" y="-1631093.7" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#myDragCrossSymbol" xlink:type="simple" visibility="hidden" xlink:actuate="onLoad" xlink:show="embed"/>
								
								 
						
					</svg>
				</g>
			
				
      </g>
      
					
			
			
	
	

	
		
	
		<svg contentScriptType="text/ecmascript" zoomAndPan="magnify" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" id="logo" version="1.0" width="500" preserveAspectRatio="xMidYMid meet" height="200" xmlns="http://www.w3.org/2000/svg" x="1040" y="-1">
			<g transform="scale(0.3)">
			
			</g>
		</svg>
	</svg>